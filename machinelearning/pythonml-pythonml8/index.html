<!DOCTYPE HTML><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta name="baidu-site-verification" content="kZmc8XTvrB"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?458cfc1440d057b6b8799400c6b2e2bf";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><meta charset="utf-8"><title>案例 （四）客流预测 | 机器学习 and 数据科学</title><meta name="author" content="王小鹏  京ICP备19037345号-1"><meta name="keywords" content="机器学习实战，数据挖掘 PDF电子书下载,电子书，PDF下载"><meta name="description" content="PDF电子书下载,电子书，PDF下载"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="案例 （四）客流预测"><meta property="og:site_name" content="机器学习 and 数据科学"><meta property="og:image" content><link href="/favicon.png" rel="icon"><link rel="alternate" href="/atom.xml" title="机器学习 and 数据科学" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">机器学习 and 数据科学</a></h1><h2><a href="/">明天幸福今天修</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article id="post-pythonml-pythonml8" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="post-content"><header><div class="icon"></div><time class="dt-published" datetime="2020-07-09T11:18:58.000Z"><a href="/machinelearning/pythonml-pythonml8/">2020-07-09</a><span id="busuanzi_container_page_pv"> &nbsp;&nbsp;&nbsp;&nbsp;阅读 <span id="busuanzi_value_page_pv"></span></span></time><h1 class="p-name title" itemprop="headline name">案例 （四）客流预测</h1></header><div class="e-content entry" itemprop="articleBody"><p>#<strong>目录</strong><br>1、项目背景<br>2、项目主要应用技术<br>3、项目数据<br>4、项目过程<br>4.1、导库<br>4.2、数据读取<br>4.3、数据探索<br>4.4、数据预处理<br>4.4.1、重复值处理<br>4.4.2、异常值处理<br>4.4.3、缺失值处理<br>4.4.4、特征构造<br>4.5、特征工程<br>4.5.1、特征相关性分析<br>4.5.2、目标相关性分析<br>4.6、模型搭建<br>4.6.1、构建特征值和目标值<br>4.6.2、划分训练和测试集<br>4.6.3、模型搭建<br>4.7、模型评估<br>4.8、模型预测及可视化<br>4.9、特征重要性分析<br>4.10、模型保存<br>4.11、模型部署<br>4.12、接口测试</p><h1 id="一、项目背景："><a href="#一、项目背景：" class="headerlink" title="一、项目背景："></a>一、项目背景：</h1><p>客流预测是城市轨道交通规划设计和运营管理的基本依据,已成为城市轨道交通建设过程中的重要环节。随着我国城市轨道交通路网的不断完善,城市轨道交通客流预测的重要性也越来越明显。本项目对城市轨道交通客流的统计特征及客流组合预测方法进行了研究，通过对城市轨道交通客流历史数据进行统计分析,得出轨道交通客流的基本统计特征。主要表现为：节假日客流的统计特征与平常日客流明显不同且不同节假日客流具有不同的统计特征；平常日客流具有一定的非线性和非平稳性,并且以周为时间单位不断波动；通过对轨道交通客流进行聚类分析,可以将平常日客流分为工作日客流和周末客流两大类。</p><p>客流研究的方向有很多，本项目主要围绕平常日客流展开分析。</p><h1 id="二、项目主要应用技术"><a href="#二、项目主要应用技术" class="headerlink" title="二、项目主要应用技术"></a>二、项目主要应用技术</h1><p>本项目用到的主要技术包括：</p><ul><li>数据科学：numpy，pandas</li><li>画图：matplotlib，seaborn</li><li>数据建模：sklearn</li><li>算法：DecisionTreeRegressor，RandomForestRegressor，LogisticRegression，LinearRegression，Ridge，Lasso</li><li>集成算法：xgboost，catboost，AdaBoostRegressor，GradientBoostingRegressor</li><li>模型保存：joblib</li><li>模型部署：flask<br>另外测试工具用的 RESTClient 。</li></ul><h1 id="三、项目数据"><a href="#三、项目数据" class="headerlink" title="三、项目数据"></a>三、项目数据</h1><p>客流数据：<br>date : 日期<br>p_flow : 客流</p><p>天气数据采集：<br>date : 日期<br>weekday : 星期<br>top_temp : 最高温<br>bot_temp : 最低温<br>weather_ : 天气<br>wind_ : 风速<br>air : 空气质量</p><p>构建数据：<br>is_holiday ： 是否节假日（1表示节假日，0表示工作日）<br>month ：当前日期所属月份<br>dayofweek ：当前日期所属星期<br>pre_date_flow ： 前一天的客流<br>MA5 ： 前5日移动平均客流<br>MA10 ： 前10日移动平均客流</p><p>研究对象：p_flow : 客流</p><h1 id="四、项目过程"><a href="#四、项目过程" class="headerlink" title="四、项目过程"></a>四、项目过程</h1><h4 id="4-1、导库："><a href="#4-1、导库：" class="headerlink" title="4.1、导库："></a>4.1、导库：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 数据科学</span><br><span class="line">import numpy as np</span><br><span class="line">import pandas as pd</span><br><span class="line"># 画图相关</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import seaborn as sns</span><br><span class="line">plt.rcParams[&apos;font.family&apos;]=&apos;SimHei&apos; # 中文乱码</span><br><span class="line">plt.rcParams[&apos;axes.unicode_minus&apos;]=False # 负号无法正常显示</span><br><span class="line">%config InlineBackend.figure_format=&apos;svg&apos; # 像素清晰</span><br><span class="line">from scipy.cluster.hierarchy import linkage, dendrogram  # 绘制树状图像    </span><br><span class="line"></span><br><span class="line"># 忽略警告</span><br><span class="line">import warnings</span><br><span class="line">warnings.filterwarnings(&apos;ignore&apos;)</span><br><span class="line"># 特征选择</span><br><span class="line">from sklearn.preprocessing import LabelEncoder, MinMaxScaler, StandardScaler, OrdinalEncoder, OneHotEncoder</span><br><span class="line"># 特征工程</span><br><span class="line">from sklearn.decomposition import PCA</span><br><span class="line">from sklearn.model_selection import train_test_split</span><br><span class="line"># 分类模型</span><br><span class="line">from sklearn.tree import DecisionTreeClassifier</span><br><span class="line">from sklearn.ensemble import RandomForestClassifier</span><br><span class="line">from sklearn.svm import LinearSVC</span><br><span class="line">from sklearn.naive_bayes import BernoulliNB  # 伯努利贝叶斯</span><br><span class="line"># 回归模型</span><br><span class="line">from sklearn.tree import DecisionTreeRegressor</span><br><span class="line">from sklearn.ensemble import RandomForestRegressor</span><br><span class="line">from sklearn.linear_model import LogisticRegression  # 一元线性回归模型</span><br><span class="line">from sklearn.linear_model import LinearRegression</span><br><span class="line">from sklearn.linear_model import Ridge  # 岭回归</span><br><span class="line">from sklearn.linear_model import Lasso</span><br><span class="line"></span><br><span class="line"># 集成算法</span><br><span class="line">from xgboost import XGBRegressor </span><br><span class="line">from catboost import CatBoostRegressor </span><br><span class="line">from sklearn.ensemble import AdaBoostRegressor</span><br><span class="line">from sklearn.ensemble import GradientBoostingRegressor </span><br><span class="line"># 模型评估</span><br><span class="line">from sklearn.metrics import recall_score, precision_score, roc_auc_score, accuracy_score</span><br></pre></td></tr></table></figure><h4 id="4-2、数据读取："><a href="#4-2、数据读取：" class="headerlink" title="4.2、数据读取："></a>4.2、数据读取：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = pd.read_csv(r&apos;E:\Files\公司业务\pkπ\2020-05\nanning_line1.csv&apos;, encoding=&apos;utf-8&apos;, parse_dates=[&apos;date&apos;])</span><br><span class="line">weather = pd.read_csv(r&apos;E:\Files\公司业务\pkπ\2020-06\nanning_weather.csv&apos;, encoding=&apos;gbk&apos;,parse_dates=[&apos;date&apos;])</span><br></pre></td></tr></table></figure><p>这里的数据读取的是公司在某城市1号线项目1年的真实客流数据，读取之后放到了df中。而天气数据是爬取的网上的天气网站的19年某城市的历史天气数据。</p><h4 id="4-3、数据探索"><a href="#4-3、数据探索" class="headerlink" title="4.3、数据探索"></a>4.3、数据探索</h4><p>数据形状：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.shape</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-4524d7c762bd3a47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>显示客流数据有365行，2列。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weather.shape</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-531f54e46c58e822.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>显示天气数据有365行，7列。<br><strong>数据类型：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.info()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-c9aac3f550cf1647.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>显示有365行不为空的客流数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weather.info()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-a746ac1439bfaf17.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>显示有365行不为空的天气数据。<br><strong>查看前几行：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.head()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-731a8bbd4cb73a8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>客流数据的前几行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weather.head()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-bf8c0d3ce852d906.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>天气数据的前几行。<br><strong>数据概览：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.describe()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-c5e8f7fd1fb12d89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weather.describe()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-e2ea72ba8310c1bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>数据合并：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df = pd.merge(df,weather,on=&apos;date&apos;)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-45d40da5cf0aef76.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>####4.4、数据预处理<br><strong>4.4.1、重复值处理：</strong></p><p><strong>查看重复值：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[df.duplicated()]</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-7b76e45175ca6b40.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>显示无重复数据。</p><p><strong>查看重复数量：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.duplicated().sum()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-97b13ab38d79bb77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>查看重复数据进行确认，结果是0，缺失无重复数据。</p><h4 id="4-4-2、异常值处理"><a href="#4-4-2、异常值处理" class="headerlink" title="4.4.2、异常值处理"></a>4.4.2、异常值处理</h4><p><strong>查看数据分布：</strong><br>让我们来查看一下1年当中数据的分布：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(15,5))</span><br><span class="line">plt.plot(df.iloc[:,0],df.iloc[:,1]/10000, label=&apos;XX1号线&apos;)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-676a38dd56614716.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>从图中我们可以看出，1年的日客流数据存在节假日客流和非节假日客流之分。节假日客流的统计特征与平常日客流明显不同且不同节假日客流具有不同的统计特征，例如春节期间，客流是明显下降的，而五一，十一期间数据陡增；平常日客流具有一定的非线性和非平稳性,并且以周为时间单位不断波动。我们来看看异常值。</p><p><strong>查看异常值：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(10,5))</span><br><span class="line">p = df.boxplot(return_type=&apos;dict&apos;)         #画箱线图，直接使用DataFrame的方法</span><br><span class="line">x = p[&apos;fliers&apos;][0].get_xdata()               # &apos;flies&apos;即为异常值的标签</span><br><span class="line">y = p[&apos;fliers&apos;][0].get_ydata()</span><br><span class="line">y.sort()</span><br><span class="line">for i in range(len(x)):</span><br><span class="line">  if i&gt;0:</span><br><span class="line">    plt.annotate(y[i], xy = (x[i],y[i]), xytext=(x[i]+0.05 -0.10/(y[i]-y[i-1]),y[i]))</span><br><span class="line">  else:</span><br><span class="line">    plt.annotate(y[i], xy = (x[i],y[i]), xytext=(x[i]+0.10,y[i]))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-0fbf24c75716cab9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><strong>找出异常数据：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[df[&apos;p_flow&apos;].isin(y)]</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-8ba600505522064f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>y = p[‘fliers’][0].get_ydata() , 返回的y就是异常值，用isin()函数判断DataFrame中是否存在特定的值；然后根据布尔索引，得到DataFrame中的异常值。</p><p><strong>删除异常值：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.drop(df[df[&apos;p_flow&apos;].isin(y)].index, inplace=True)</span><br></pre></td></tr></table></figure><p>查看删除的效果，再执行一遍箱线图：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(10,5))</span><br><span class="line">p = df.boxplot(return_type=&apos;dict&apos;)         #画箱线图，直接使用DataFrame的方法</span><br><span class="line">x = p[&apos;fliers&apos;][0].get_xdata()               # &apos;flies&apos;即为异常值的标签</span><br><span class="line">y = p[&apos;fliers&apos;][0].get_ydata()</span><br><span class="line">y.sort()</span><br><span class="line">for i in range(len(x)):</span><br><span class="line">  if i&gt;0:</span><br><span class="line">    plt.annotate(y[i], xy = (x[i],y[i]), xytext=(x[i]+0.05 -0.10/(y[i]-y[i-1]),y[i]))</span><br><span class="line">  else:</span><br><span class="line">    plt.annotate(y[i], xy = (x[i],y[i]), xytext=(x[i]+0.10,y[i]))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-8b4f13e5a9aa039f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>可以看到异常值已经清除完毕。<br><strong>4.4.3、缺失值处理</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[df[&apos;flow&apos;].isnull()]</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-45f54416c87675d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>提示数据中无缺失值。<br><strong>4.4.4、特征构造</strong></p><p>增加是否节假日：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;is_holiday&apos;] = df[&apos;date&apos;].apply(lambda x: 1 if is_holiday(x)==True else 0 )</span><br><span class="line">df.index = range(df.shape[0])  # 恢复索引</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-56564e50dad791d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>客流特征可能跟今天是否为节假日有关，节假日包括法定节日和周末。一般来说非工作日（周末和节假日）的客流和工作日的客流是有差异的，所以增加了这个特征。</p><p>增加月份：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;month&apos;] = df[&apos;date&apos;].map(lambda x: x.month)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-f053e20f9ab57e28.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>不同月份的客流可能会存在差异，故增加此特征进行探索。</p><p>增加星期：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;dayofweek&apos;]=df[&apos;date&apos;].dt.dayofweek +1 # +1 之后数字几就代表星期几</span><br></pre></td></tr></table></figure><p>客流可能存在以星期为规律变换的现象，所以提取了星期作为特征之一。</p><p>增加前一天的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;pre_date_flow&apos;] = df.loc[:,[&apos;p_flow&apos;]].shift(1)</span><br></pre></td></tr></table></figure><p>作为时间序列问题，前一天的客流和今天的客流可能是存在某种关系的。比如前一天是第一天开始放假，客流下降，那么今天的客流也大概率是下降的。这里用了 shift()函数来对数据进行平移，参数1表示平移1个单位，取昨天的数据。如果是-1就表示平移到下一个单位，取当前时间的第二天数据。<br><img src="https://upload-images.jianshu.io/upload_images/7289495-31eec41202ff5800.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>5日移动平均：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;MA5&apos;] = df[&apos;p_flow&apos;].rolling(5).mean()</span><br></pre></td></tr></table></figure><p>同样考虑时间序列问题，前5天的平均客流也是会对今天的客流数据产生影响。故增加此特征。<br><img src="https://upload-images.jianshu.io/upload_images/7289495-8508737bed7f5a7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>10日移动平均：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[&apos;MA10&apos;] = df[&apos;p_flow&apos;].rolling(10).mean()</span><br></pre></td></tr></table></figure><p>同理增加10日移动平均客流。<br><img src="https://upload-images.jianshu.io/upload_images/7289495-de65ee5f75240dfc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>删除节假日：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">holiday_list =[ &apos;2019-01-01&apos;</span><br><span class="line">               ,&apos;2019-02-04&apos;,&apos;2019-02-05&apos;,&apos;2019-02-06&apos;,&apos;2019-02-07&apos;,&apos;2019-02-08&apos;,&apos;2019-02-09&apos;,&apos;2019-02-10&apos;</span><br><span class="line">               ,&apos;2019-04-05&apos;,&apos;2019-04-06&apos;,&apos;2019-04-07&apos;</span><br><span class="line">               ,&apos;2019-05-01&apos;,&apos;2019-05-02&apos;,&apos;2019-05-03&apos;,&apos;2019-05-04&apos;</span><br><span class="line">               ,&apos;2019-06-07&apos;,&apos;2019-06-08&apos;,&apos;2019-06-09&apos;</span><br><span class="line">               ,&apos;2019-09-13&apos;,&apos;2019-09-14&apos;,&apos;2019-09-15&apos;</span><br><span class="line">               ,&apos;2019-10-01&apos;,&apos;2019-10-02&apos;,&apos;2019-10-03&apos;,&apos;2019-10-04&apos;,&apos;2019-10-05&apos;,&apos;2019-10-06&apos;,&apos;2019-10-07&apos;</span><br><span class="line">              ]</span><br><span class="line">df = df[df[&apos;date&apos;].isin(holiday_list) == False]</span><br><span class="line">df.index = range(df.shape[0])</span><br><span class="line">df.head()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-cd24cb1365588a7f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>节假日对于日常规律的客流数据而言，是异常值，所以进行删除。</p><p><strong>删除缺失值：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.dropna(inplace=True)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-6bd9767c41b9314d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h5 id="4-5、特征工程"><a href="#4-5、特征工程" class="headerlink" title="4.5、特征工程"></a>4.5、特征工程</h5><p><strong>4.5.1、特征相关性分析</strong><br><strong>获取所有特征变量：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feature = df.drop([&apos;p_flow&apos;],axis=1)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-2da9dbf7dd7059c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>特征之间的相关性，得到相关性矩阵：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">corr = feature.corr()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-d6b4dd5d582a6f7a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>特征矩阵进行热力图可视化展示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(10,6))</span><br><span class="line">ax = sns.heatmap(corr, xticklabels=corr.columns,</span><br><span class="line">                 yticklabels=corr.columns, linewidths=0.2, cmap=&quot;RdYlGn&quot;,annot=True)</span><br><span class="line">plt.title(&quot;Correlation between variables&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-a4cf4e2f7d0622d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>特征相关性分析，是为了查看特征之间是否存在多重共线性，如果有多重共线性的话，就要对相关性特别高的特征进行有选择的删除。从热力图的结果来看，MA5和MA10的相关性是最高的，但也可以接受，不需要对特征进行删除。</p><p><strong>4.5.2、目标相关性分析</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df_onehot = pd.get_dummies(df)</span><br><span class="line">df_onehot.head()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-97656d07bd6d27a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>可视化展示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(20,4))</span><br><span class="line">df_onehot.corr()[&apos;p_flow&apos;].sort_values(ascending=False).plot(kind=&apos;bar&apos;)</span><br><span class="line">plt.title(&apos;Correlation between p_flow and variables&apos;)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-b82f2cb7abba55fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>分析：</strong> 从上图中我们可以看出：<br>1、客流和前一天的客流（pre_date_flow）, 是否为节假日（is_holiday）, 周期（dayofweek）, 前10日平均客流（MA10），前5日平均客流（MA5） 是有相关性的，并且是正相关。</p><p>2、从天气情况来看，客流和低温（top_temp_12C），大风 (wind_东南风_5级) ， 高温（top_temp_35C），成正相关。和舒服的气温（weather_晴天），舒适的温度（bot_temp_23C），成负相关。说明恶劣天气的时候，选择乘坐地铁的人比较多，而天气好的时候，大家出行的可选性比较多。</p><p>3、从星期来看，和星期五，星期六，星期日成正相关，和周一，周二，周三，周四成负相关。说明周末的客流数更多，而工作日的客流更少。由于我们取的数据是普通城市的客流数据，这个和一线城市的客流情况是不同的。我们下面来通过对星期进行聚类来验证。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 按星期聚类</span><br><span class="line">table = pd.pivot_table(df, index=[&apos;dayofweek&apos;], values=[&apos;p_flow&apos;], aggfunc=&apos;sum&apos;)  # 对数据进行聚合</span><br><span class="line">plt.figure(figsize=(11,4))</span><br><span class="line">Z = linkage(table, method=&apos;ward&apos;, metric=&apos;euclidean&apos;)</span><br><span class="line">p = dendrogram(Z,0)</span><br><span class="line">plt.xlabel(&quot;星期&quot;, fontsize=14)</span><br><span class="line">plt.ylabel(&quot;欧式距离&quot;, fontsize=14)</span><br><span class="line">plt.title(&quot;XX1号线星期聚类图&quot;, fontsize=16)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-343867e15e9bc522.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>可以看出，周一，周二，周三，周四，是聚成一类，周五，周六，周日聚成一类。</p><h4 id="4-6、模型搭建"><a href="#4-6、模型搭建" class="headerlink" title="4.6、模型搭建"></a>4.6、模型搭建</h4><p><strong>4.6.1、构建特征值和目标值</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 构建特征值X 和目标值 Y </span><br><span class="line">X = df[[&apos;is_holiday&apos;,&apos;month&apos;,&apos;dayofweek&apos;,&apos;pre_date_flow&apos;,&apos;MA5&apos;,&apos;MA10&apos;]]</span><br><span class="line">y = df[&apos;p_flow&apos;]</span><br><span class="line">X.index = range(X.shape[0])</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-3f6c77959a5ee206.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>4.6.2、划分训练集和测试集</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">X_length = X.shape[0]</span><br><span class="line">split = int(X_length*0.9)</span><br><span class="line">X_train, X_test = X[:split], X[split:]</span><br><span class="line">y_train, y_test = y[:split], y[split:]</span><br></pre></td></tr></table></figure><p>需要注意的是，这里的模型是一个时间序列问题，需要用前面的时间数据来预测后面的时间序列问题，故在此用前90%作为训练集，后10%作为测试集。而不能用train_test_split方法，对训练集和测试集进行随机划分。</p><p><strong>4.6.3、模型搭建</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 回归算法</span><br><span class="line">Regressors=[[&quot;Random Forest&quot;,RandomForestRegressor()]</span><br><span class="line">             ,[&quot;Decision Tree&quot;,DecisionTreeRegressor()]</span><br><span class="line">             ,[&quot;Lasso&quot;,Lasso()]</span><br><span class="line">             ,[&quot;AdaBoostRegressor&quot;, AdaBoostRegressor()]</span><br><span class="line">             ,[&quot;GradientBoostingRegressor&quot;, GradientBoostingRegressor()]</span><br><span class="line">             ,[&quot;XGB&quot;, XGBRegressor()]</span><br><span class="line">             ,[&quot;CatBoost&quot;, CatBoostRegressor(logging_level=&apos;Silent&apos;)]  </span><br><span class="line">]</span><br><span class="line">reg_result=[]</span><br><span class="line">names=[]</span><br><span class="line">prediction=[]</span><br><span class="line">for name,reg in Regressors:</span><br><span class="line">    reg = reg.fit(X_train, y_train)</span><br><span class="line">    y_pred=reg.predict(X_test)</span><br><span class="line">    #回归评估</span><br><span class="line">    mae = mean_absolute_error(y_test,y_pred)</span><br><span class="line">    mse = mean_squared_error(y_test,y_pred)</span><br><span class="line">    r2= r2_score(y_test,y_pred)</span><br><span class="line">    class_eva=pd.DataFrame([mae,mse,r2])</span><br><span class="line">    reg_result.append(class_eva)</span><br><span class="line">    name=pd.Series(name)</span><br><span class="line">    names.append(name)</span><br><span class="line">    y_pred=pd.Series(y_pred)</span><br><span class="line">    prediction.append(y_pred)</span><br></pre></td></tr></table></figure><p><strong>4.7、模型评估</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">names=pd.DataFrame(names)</span><br><span class="line">names=names[0].tolist()</span><br><span class="line">result=pd.concat(reg_result,axis=1)</span><br><span class="line">result.columns=names</span><br><span class="line">result.index=[&quot;mae&quot;,&quot;mse&quot;,&quot;r2&quot;]</span><br><span class="line">result</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-b01561c8ece6f480.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>我们可以看到随机森林的r^2表现最好，mse均方误差也是最小，那么我们选择用随机森林进行预测。</p><p><strong>4.8、模型预测及可视化：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rfc = RandomForestRegressor(n_estimators=50     </span><br><span class="line">                          ,random_state=1       </span><br><span class="line">                          ,bootstrap=True      </span><br><span class="line">                          ,oob_score=True     </span><br><span class="line">                            )</span><br><span class="line">rfc = rfc.fit(X_train, y_train)</span><br><span class="line">y_pred = reg.predict(X_test)</span><br></pre></td></tr></table></figure><p>预测结果可视化：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(15,6))</span><br><span class="line">plt.title(&apos;预测结果图&apos;)</span><br><span class="line">plt.plot(y_test.ravel(),label=&apos;真实值&apos;)</span><br><span class="line">plt.plot(y_pred,label=&apos;预测值&apos;)</span><br><span class="line">plt.xticks([])</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-01b321dfb0ca00a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>4.9、特征重要性分析</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rfc.feature_importances_</span><br><span class="line">features = X_train.columns</span><br><span class="line">impor = pd.DataFrame([*zip(features, rfc.feature_importances_)])</span><br><span class="line">impor.columns= [&apos;feature&apos;, &apos;importance&apos;]</span><br><span class="line">impor.sort_values(by=&apos;importance&apos;, inplace = True)</span><br><span class="line"># 随机森林模型选择特征重要性</span><br><span class="line">plt.barh(impor[&apos;feature&apos;], height=0.5, width=impor[&apos;importance&apos;])</span><br><span class="line">plt.title(&quot;随机森林模型选择特征重要性&quot;)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/7289495-9dbd82c783cd25b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><strong>4.10、模型保存：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import joblib</span><br><span class="line"># 模型保存</span><br><span class="line">joblib.dump(reg, &apos;keliu.pkl&apos;)</span><br></pre></td></tr></table></figure><p><strong>4.11、模型部署：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,request,jsonify</span><br><span class="line">import joblib</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"># /keliu是路由地址，methods是支持http方法，可以分为POST和GET</span><br><span class="line">@app.route(&apos;/keliu&apos;,methods=[&quot;POST&quot;])</span><br><span class="line">def keliu():</span><br><span class="line">    # 获得post传过来的数据</span><br><span class="line">    data = request.get_json(force=True)</span><br><span class="line">    model = joblib.load(&apos;keliu.pkl&apos;)</span><br><span class="line">    pro = model.predict(data)</span><br><span class="line">    info = &#123;&apos;result&apos;: str(pro)&#125;</span><br><span class="line">    return jsonify(info)#返回结果</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    # host=&apos;0.0.0.0&apos;是为了接口能被局域网中其他机器访问，port为端口号</span><br><span class="line">    app.run(host=&apos;0.0.0.0&apos;, port=8080)</span><br></pre></td></tr></table></figure><p><strong>4.12、接口测试：</strong><br>接口调取<br><img src="https://upload-images.jianshu.io/upload_images/7289495-392fee69666ea31d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>接口返回：<br><img src="https://upload-images.jianshu.io/upload_images/7289495-6dc3d9ceec9512af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p></div><footer><div class="categories"><a href="/categories/machinelearning/">机器学习</a></div><div class="tags"><a href="/tags/content/">content</a>, <a href="/tags/machine-learning/">machine learning</a></div><div class="addthis addthis_toolbox addthis_default_style"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a> <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a> <a class="addthis_counter addthis_pill_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script><div class="clearfix"></div></footer></div></article><section id="comment"><h1 class="title">留言</h1><div id="fb-root"></div><script>!function(e,t,n){var a,c=e.getElementsByTagName(t)[0];e.getElementById(n)||((a=e.createElement(t)).id=n,a.src="//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345",c.parentNode.insertBefore(a,c))}(document,"script","facebook-jssdk")</script><div class="fb-comments" data-href="http://www.wangpengcufe.com/machinelearning/pythonml-pythonml8/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div></section></div></div><aside id="sidebar" class="alignright"><script language="javascript">function search(e){return e.method="get",e.action="http://www.baidu.com/baidu",document.search_form.word.value=document.search_form.word.value,!0}</script><div class="search"><form name="search_form" target="_blank" onsubmit="search(this)"><input type="search" name="word" results="0" placeholder="百度站内搜索" onblur='this.value=""'></form></div><div class="widget tag"><h3 class="title">分类</h3><ul class="entry"><li><a href="/categories/read/">read</a><small>69</small></li><li><a href="/categories/tools/">工具</a><small>7</small></li><li><a href="/categories/machinelearning/">机器学习</a><small>26</small></li><li><a href="/categories/navigate/">菜单导航</a><small>1</small></li><li><a href="/categories/datadownload/">资料下载</a><small>1</small></li></ul></div><div class="widget tag"><h3 class="title">标签</h3><ul class="entry"><li><a href="/tags/content/">content</a><small>101</small></li><li><a href="/tags/library/">library</a><small>1</small></li><li><a href="/tags/machine-learning/">machine learning</a><small>26</small></li><li><a href="/tags/navigate/">navigate</a><small>1</small></li><li><a href="/tags/tools/">tools</a><small>7</small></li></ul></div><div class="widget tag"><h3 class="title">友情链接</h3><ul class="entry"><li><a href="http://blog.didispace.com" title="程序员DD">程序员DD</a></li><li><a href="https://mangoroom.cn" title="芒果的个人博客">芒果的个人博客</a></li><li><a href="http://www.baimin.com" target="_blank">百鸣网站百科</a></li><li><a href="http://blog.sina.com.cn/u/2435344920" target="_blank">默默读书</a></li><li><a href="https://www.jianshu.com/u/510007ddad06" target="_blank">王小鹏的随笔（简书）</a></li><li><a href="https://me.csdn.net/weixin_42438712" target="_blank">机器学习（csdn博客）</a></li><li><a href="https://zhuanlan.zhihu.com/c_1182309165824901120" target="_blank">机器学习（知乎）</a></li><li><a href="http://meixiaohan.com/" target="_blank">小寒大人的blog</a></li><li><a href="https://baippt.com/" target="_blank">ppt模板免费下载</a></li><li><a href="http://www.youneedcn.com/" target="_blank">你要的资源</a></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2020 王小鹏 京ICP备19037345号-1</div><div class="clearfix"></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></footer><script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">jQuery(".fancybox").fancybox()</script></body></html>